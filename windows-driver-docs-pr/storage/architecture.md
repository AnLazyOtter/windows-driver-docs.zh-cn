---
title: 体系结构
description: 体系结构
ms.assetid: 6a50cba8-f989-4662-8e1d-2df462cb48d9
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 34ed3905ec4e227de7f9a8e92fed16529ee83725
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/31/2019
ms.locfileid: "56563790"
---
# <a name="architecture"></a>体系结构


在讨论的枚举和 1667年兼容大容量存储设备的发现过程之前, 是有助于您了解该过程以前存在的旧的 USB 大容量存储设备。

当 USB 大容量存储设备连接到 Windows XP 或 Vista 的主机系统时，内核模式驱动程序 USBStor 安装，并加载。 此驱动程序创建逻辑单元 (Lun) 存在数等于在设备上的磁盘物理设备对象 (PDOs) 数。 图 1 显示了单一的 LUN USB 闪存设备 (UFD) 的驱动程序堆栈。

![图 1： 为旧的 usb 大容量存储驱动程序堆栈](images/enhancedstorage-1.png)

当设备连接到系统时，LUN 0 位置可用的数据存储介质是可通过磁盘 PDO 所表示的磁盘设备。 PartMgr 会识别媒体上存储的分区信息和 VolMgr 使用此信息来创建一个或多个卷 PDOs 表示媒体上的逻辑分区。 每个卷检查以确定文件系统类型，以及然后将相应的文件系统装载为该卷。 应用程序然后处理此已装入的卷通过系统 API，使用熟悉的文件路径命名法，其中包含 DOS 驱动器号 (例如， *e:\\myfile*)。

旧 1667年大容量存储设备的一个主要区别是在授权之前, 1667 ACT 的用户数据部分完全无法访问。 与之相比，旧的大容量存储，确定它们持有不可移动的媒体的行为。 对于具有不可移动的媒体的已连接设备，存储的数据必须可访问。 任何行为相反假定是由于设备错误导致 Windows OS 平台和其附随应用程序生态系统。 连接意味着可访问，因此添加已连接但无法访问设备会将其公开基础的假设，并按以下方式中断用户体验：

-   尝试从命令提示符窗口中报告"0xC0000013"，在设备中没有介质的对话框访问驱动器。

-   尽管当前无法访问的驱动器卷显示为其 (实际上不是由已装载的文件系统，只需创建，用于提供针对初始化、 分区和格式设置)。 单击此卷 shell 或打开/保存公共对话框中的图标会导致以下插入磁盘对话框。 这不是连接 UFD 的用户可操作指令。

-   所有**开放**并**另存为**所得的 GetOpenFileName 和 GetSaveFileName 例程通过调用的应用程序的对话框结果在同一对话框中显示。

-   使用 Win32 文件系统 Api 的任何应用程序可能会遇到由于已连接但无法访问存储的意外的行为。

-   启动错误日志条目因出现访问问题而出现的未经身份验证的设备的报告 RMB = 0。

-   外壳自动播放假定驱动器是连接时可立即访问。 自动播放不是以适应成功进行身份验证过程完成后才可访问一个驱动器的情况。 这种行为是不同于常用的命令行程序大容量存储设备体验。

因此，为了避免令人困惑的错误对话框和含义模糊的应用程序错误，对系统卷的演示文稿完全一直处于挂起状态对相应的操作的授权的访问已被授予通过 1667年身份验证。

图 1 中 USBStor 上给定 ACT 创建接收器存在的每种类型的一个新的 PDO。 在图中，密码和证书身份验证接收器显示。 每个接收器接收一个唯一的 PDO 依据加载相应接收器驱动程序。 用户模式下授权过程创建的句柄接收器 PDO 与设备进行身份验证进行通信。 此时设备尚未枚举系统; 的卷因此，没有关于无法访问的存储目标分清。 仅 1667年接收器是可访问，并且这些函数将设备引入 ACT 用户的基础用户数据可能会访问在其中的状态。 为了简单明确起见，会显示与单个 ACT 的设备，但相同的原则也适用的设备上的多个行为时。

图 2 和 3 显示从 1667 UFD 首次连接到的点的操作进行身份验证和相应的卷提供给系统的时间发生的两个步骤。

![图 2： 未尚未出现 （步骤 1） 卷。 仅身份验证接收器是可见的。](images/enhancedstorage-2.png)

PDO 程序被延迟到操作已进入访问磁盘的创建授权状态。 已成功完成身份验证并授予访问权限后，到 USBStor 跟进 IOCTL 表示此授权状态更改。 USBStor，进而创建磁盘 PDO，并基于此磁盘 PDO，卷和文件系统驱动程序堆栈进行实例化。 它是通过 ACT 数据由系统可访问此卷。

![图 3： 授予 （步骤 2） 访问权限。 显示磁盘 pdo 和卷。](images/enhancedstorage-3.png)

设备已授予的对自身的访问权限的最终授权机构。 因此，如果由于某种原因 misjudged 授权状态，最坏的情况的最终结果是 USBStor 错误地创建为不可访问 ACT PDO 的磁盘。 但是，这些数据保持安全根据执法机构提供的设备。 延迟的磁盘 PDO 机制只是启用的用户体验更接近于提供适用于旧的大容量存储设备。 它不是作为访问控制机制。 1667 设备负责用于管理安全访问权限的行为。

图 3 引用的内置密码和证书接收器驱动程序，而设计的可扩展特性还允许第三方供应商参与身份验证和授权工作流，ACT 通过编写自己的驱动程序。 此外，其函数是与身份验证过程不相关的泛型真空区可能还进行发现和访问。

IEEE 1667 规范允许使用多达 255 独立接收器，每个设备上存在的 ACT。 不仅序号，而且由对应于该接收器在设备上的特定函数实现与对应的唯一接收器类型 ID 标识每个接收器。 图 3 所示的设备，对于单个 ACT 公开证书和密码身份验证接收器。 第一个接收器是密码接收器，因为为由密码接收器类型标识符。 第二个接收器是被识别为证书接收器通过不同的接收器类型标识符。 所有接收器类型标识符对给定的接收器函数都是唯一和用于控制主体 IEEE 1667 颁发。

图 4 显示了每个独立的驱动程序处理的多个具有多个接收器类型的设备。

![图 4： 供应商或不可能实现其他接收器，无论是用于身份验证。](images/enhancedstorage-4.png)

对于使用完全参与主机身份验证过程的第三方身份验证的设备，供应商必须创建身份验证接收器驱动程序和身份验证客户端。 然后，ActiveStorage API 简化了授权第三方提供的身份验证客户端进程通过其驱动程序的第三方接收器与之通信通过设备的访问权限的过程。 ActiveStorage API 设计文档中介绍了 ActiveStorage API 和第三方身份验证客户端之间的接口。

除了第三方身份验证接收器 1667年设备也可能会使其他接收器。 可以部署第三方驱动程序提供给定的接收器的访问权限，但这样的驱动程序不是绝对必要。 供应商还可选择要与其而无需接收器驱动程序; 接收器因此无需完全部署驱动程序。 第三方应用程序可能直接向设备发送原始接收器命令。

使用与在原始模式下保持接收器的接收器驱动程序的优缺点如下所示：

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">接收器驱动程序</th>
<th align="left">原始接收器</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p><strong>-</strong> 所需的驱动程序部署。</p></td>
<td align="left"><p>+ 不是必需的驱动程序。</p></td>
</tr>
<tr class="even">
<td align="left"><p><strong>+</strong> 接收器驱动程序强制实施的访问和事务控制。</p></td>
<td align="left"><p>- 仅基本访问和事务控制提供的原始 I/O USBStor 通过。</p></td>
</tr>
<tr class="odd">
<td align="left"><p><strong>+</strong> 可加入授权工作流和 UI。</p></td>
<td align="left"><p>- 未参与授权工作流和 UI。</p></td>
</tr>
<tr class="even">
<td align="left"><p><strong>+</strong> 上下文菜单操作谓词。</p></td>
<td align="left"><p>- 没有上下文菜单操作谓词。</p></td>
</tr>
<tr class="odd">
<td align="left"><p><strong>+</strong> 接收器驱动程序中包含的转换/验证层。</p></td>
<td align="left"><p>- 直接向设备发送的原始命令。</p></td>
</tr>
<tr class="even">
<td align="left"><p><strong>+</strong> 接收器驱动程序提供了 multicommand 操作的事务完整性。</p></td>
<td align="left"><p>- SPO 和 SPI 级别的基本事务完整性。</p></td>
</tr>
</tbody>
</table>

 

这些注意事项可能会告知是否部署其特定接收器的接收器驱动程序供应商的决策。 在某些情况下，剩余无人驾驶、 原始接收器访问足以为单个客户端应用程序，详细了解该接收器的操作。 若要使这种方法适合，供应商还必须确保同时访问多个应用程序不会构成其设备的问题。

在其他情况下，供应商可能想要提供更受限制的接收器的访问权限。 如果是，则需要更广泛的转换和验证层。 另一个供应商要求是为与驱动器卷相对应的 shell 驱动器文件夹图标的上下文菜单上提供的自定义操作。 出于这些原因，供应商可以选择要部署接收器驱动程序提供其设备上的专有接收器的访问权限。
