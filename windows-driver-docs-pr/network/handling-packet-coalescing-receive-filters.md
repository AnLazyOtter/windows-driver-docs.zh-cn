---
title: 处理数据包合并接收筛选器
description: 处理数据包合并接收筛选器
ms.assetid: 83FF780F-6B8F-4222-90F0-42037FFF7653
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: b48ea9fca3fdab6780950e61726f3feab2b9c6b5
ms.sourcegitcommit: a33b7978e22d5bb9f65ca7056f955319049a2e4c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/31/2019
ms.locfileid: "56543616"
---
# <a name="handling-packet-coalescing-receive-filters"></a>处理数据包合并接收筛选器


多个接收筛选器下载到通过 OID 方法请求的微型端口驱动程序[OID\_接收\_筛选器\_设置\_筛选器](https://msdn.microsoft.com/library/windows/hardware/ff569795)。 每个筛选器可以指定一个或多个测试 (*标头字段测试*) 网络适配器用来确定是否应在适配器上的硬件合并缓冲区中合并接收的数据包。

微型端口驱动程序配置的网络适配器的接收筛选器之前，该驱动程序应进行优化的硬件功能的适配器的接收筛选器。 例如，所有接收筛选器需要标头字段测试 MAC 标头。 因此，该驱动程序可以优化筛选器规则根据此测试的结果。 这允许适配器，以确定哪些开放系统互连 (OSI) 第 3 (L3) 层和层 4 (L4) 标头字段测试，以执行下一步。

只要网络适配器已配置的接收筛选器，它必须执行以下步骤：

-   必须与根据收到的数据包匹配特定筛选器的所有标头字段测试参数，以便 coalesce 合并缓冲区中的数据包。

    网络适配器的接收筛选器的所有标头字段测试结果进行组合使用逻辑 AND 运算。 也就是说，如果任何标头字段测试包含在的数组[ **NDIS\_接收\_筛选器\_字段\_参数**](https://msdn.microsoft.com/library/windows/hardware/ff567169)结构接收筛选器失败，接收到的数据包不符合指定的筛选器条件和必须不合并。

-   网络适配器仅会检查数据包数据根据指定的标头字段测试参数。 适配器必须忽略哪些标头未指定字段测试数据包中的所有标头字段。

-   如果接收的数据包与匹配任何接收筛选器的所有标头字段测试，网络适配器必须 coalesce 硬件合并缓冲区中的数据包。 一旦合并的第一个数据包，网络适配器必须启动硬件计时器，并且必须将过期时间设置为值**MaxCoalescingDelay**的成员[ **NDIS\_接收\_筛选器\_参数**](https://msdn.microsoft.com/library/windows/hardware/ff567181)结构匹配的接收筛选器。

-   更多数据包接收到的匹配数据包合并接收筛选器，网络适配器将将其放入缓冲区中，合并。

    如果尚未运行硬件计时器，适配器必须不停止或重新启动用于匹配的接收筛选器的计时器。 但是，适配器可以配置硬件计时器最小的到期值匹配的接收筛选器。 例如，当驱动程序收到数据包匹配接收筛选器时，才*X*，适配器与指定的到期值启动计时器，为接收筛选器。 如果适配器然后收到的数据包，匹配接收筛选器*Y*，适配器可以为接收筛选器重新配置指定的到期值与硬件计时器。

    **请注意**  在计时器剩余的时间不超过接收筛选器的过期时间时，网络适配器必须不重新配置硬件计时器。

     

-   一旦接收到的数据包已合并，网络适配器将生成中断，如果发生以下事件：

    -   如果硬件合并缓冲区中的可用空间达到特定于硬件的低水位标记，网络适配器必须生成接收中断，以便的微型端口驱动程序可以处理的合并的接收数据包。

    -   如果用于对硬件合并缓冲区硬件计时器过期，网络适配器必须生成接收中断，以便的微型端口驱动程序可以处理的合并的接收数据包。

    -   如果清除接收筛选器和数据包具有已合并与该筛选器匹配，网络适配器必须生成接收中断，以便的微型端口驱动程序可以处理的合并的接收数据包。

    -   如果接收的数据包不匹配任何接收筛选器，网络适配器必须生成接收中断，以便的微型端口驱动程序可以处理所接收的数据包。 如果任何数据包已合并，微型端口驱动程序还必须处理这些数据包。

    -   如果网络适配器会产生任何其他中断状态不是接收中断的中断，网络适配器还必须指示接收中断状态，以便的微型端口驱动程序可以处理合并接收的数据包。

    只要生成中断，网络适配器必须停止硬件计时器，如果它尚未过期且必须清除硬件合并缓冲区。

微型端口驱动程序必须维护一个合并的数据包的计数器，其中包含具有匹配的数据包的合并筛选器的接收数据包数的值。 NDIS 查询通过 OID 查询请求的此计数器[OID\_数据包\_COALESCING\_筛选器\_匹配\_计数](https://msdn.microsoft.com/library/windows/hardware/hh451826)。

网络适配器仅执行数据包合并时硬件运行完整的电源状态。 低功耗状态硬件时，适配器必须根据已卸载到通过 OID 集请求的适配器的唤醒模式的唯一筛选器收到数据包[OID\_PNP\_启用\_唤醒\_向上](https://msdn.microsoft.com/library/windows/hardware/ff569775)。

当为全功率状态转换的网络适配器时，微型端口驱动程序必须执行以下步骤：

-   微型端口驱动程序必须配置网络适配器以丢弃硬件合并缓冲区中任何合并的数据包。 网络适配器可能会有合并这些数据包时已转换为低功耗状态。

-   微型端口驱动程序必须配置网络适配器的数据包设置合并接收已下载到低功耗转换之前的驱动程序的筛选器。

-   微型端口驱动程序必须清除合并的数据包计数器。

 

 





