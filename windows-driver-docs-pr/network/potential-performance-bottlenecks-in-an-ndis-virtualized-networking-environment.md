---
title: 虚拟化网络环境中的性能瓶颈
description: NDIS 虚拟化网络环境中的潜在性能瓶颈
ms.assetid: D295E450-C8AF-43A9-B169-5387EB2A2CF0
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: bf18704287fea57bc8a4aea36c27095c64fa3a0e
ms.sourcegitcommit: 0cc5051945559a242d941a6f2799d161d8eba2a7
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "63342996"
---
# <a name="potential-performance-bottlenecks-in-an-ndis-virtualized-networking-environment"></a>NDIS 虚拟化网络环境中的潜在性能瓶颈





中的网络环境，支持设备共享，虚拟接口具有其自己的媒体访问控制 (MAC) 地址公开每个 HYPER-V 子分区中。 这些虚拟接口使用基础虚拟机总线 (VMBus) 连接到在 HYPER-V 父分区的管理操作系统中运行的 HYPER-V 可扩展交换机模块上的端口。 可扩展交换机将不同分区中的所有传出帧传输通过发出到基础共享的网络适配器的发送请求。

物理网络适配器指示最多可扩展交换机管理操作系统中收到的所有传入的帧。 可扩展交换机使用的目标 MAC 地址将指示传入帧分配给虚拟网络适配器。 为每个子分区，传入帧必须从管理操作系统中的网络适配器缓冲区复制到辅助从关联的子分区已预先分配的缓冲区。 通知发送到具有挂起的帧每个虚拟接口。 每个子分区中的虚拟接口指示过量传输驱动程序传入的帧。 确定应用程序后, 传输驱动程序的数据有效负载从辅助缓冲区复制到的应用程序的缓冲区。

因此，在虚拟化环境中，传入接收到的帧都复制两次，第一次的网络适配器缓冲区到从目标内存地址空间的子分区，分配的临时缓冲区，然后再次从这临时向应用程序缓冲区的缓冲区。 管理操作系统中的可扩展交换机必须使用的 CPU 周期以分析传入的帧并将它们放在单独的队列，根据其目标 MAC 地址。

下图显示了性能瓶颈以虚拟化环境中得到处理。

![关系图演示性能瓶颈以接收虚拟化环境中处理](images/vmqsyntheticpaths.png)

在上图中的性能问题包括：

-   必须检查每个传入的数据包，以确定目标虚拟网络适配器。

-   接收到的数据必须从父分区的内存地址空间复制到子分区的内存地址空间。

-   缺少的并发性中断和 dpc 进行标记。

### <a name="overcoming-performance-bottlenecks-with-vmq"></a>使用 VMQ 的用来解决性能瓶颈

解决性能问题，虚拟机队列 (VMQ) 接口允许：

-   通过实现在硬件中进行筛选的 MAC 地址来确定目标子分区将网络适配器。

-   使用 DMA 将接收到的数据包传输到子分区的内存地址空间直接将网络适配器。

-   微型端口驱动程序提供的该值指示可中断和 DPC 并发接收到不同的 Cpu 上的不同的子分区的数据包。

**请注意**  从外部网络接收的数据包仍将通过 VMBus 转发由管理操作系统到来宾操作系统。

 

VMQ 接口的详细信息，请参阅[虚拟机队列 (VMQ)](virtual-machine-queue--vmq-.md)。

### <a name="overcoming-performance-bottlenecks-with-sr-iov"></a>与 SR-IOV 的用来解决性能瓶颈

单个根 I/O 虚拟化 (SR-IOV) 接口用于有效地共享多个子分区间的 PCI Express (PCIe) 设备提供基于标准的基础。 物理 I/O 资源是否已虚拟化中 PCIe 设备，因此每个设备提供多个虚拟的 I/O 接口调用*虚函数*(VFs)。 管理操作系统可以在设备上配置每个 VF 并将其分配给特定子分区。

VF 公开为子分区的硬件设备。 来宾操作系统和 VF 之间直接流动的数据的所有数据包。 这消除了管理操作系统和数据流量的子分区之间的软件路径。 它会绕过对参与由管理操作系统中的数据移动通过为每个子分区提供独立的存储空间、 中断和 DMA 流。 帧发送到外部网络使用的物理端口的设备或另一个子分区使用连接到 VF 的内部端口。

在所有情况下，SR-IOV 接口无需为有关管理操作系统中的数据路径的任何操作。 因此，SR-IOV 接口提供以下功能：

-   提高的 I/O 吞吐量并降低的 CPU 使用率。

-   较低的延迟。

-   改进的可伸缩性。

有关 SR-IOV 接口的详细信息，请参阅[单根 I/O 虚拟化 (SR-IOV)](single-root-i-o-virtualization--sr-iov-.md)。

 

 





