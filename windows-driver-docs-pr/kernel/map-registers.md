---
title: 映射寄存器
description: 映射寄存器
ms.assetid: 0404f487-7a4f-43be-bbe0-b7da2087b8aa
keywords:
- 内存管理 WDK 内核，映射寄存器
- 映射寄存器 WDK 内核
- 虚拟地址空间映射 WDK 内核
- 逻辑地址空间映射 WDK 内核
- 物理地址空间映射 WDK 内核
- 映射内存
- 地址空间映射 WDK 内核
- 散播-聚集功能 WDK 内核
- 转换地址空间 WDK 内核
- 内存管理 WDK 内核，地址映射
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: a347125d5db29dd5acbe881fd6a65a48f9830785
ms.sourcegitcommit: e753fdd987a1bdbc4383704e18c2d81235fe9e05
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/06/2019
ms.locfileid: "65171961"
---
# <a name="map-registers"></a>映射寄存器





执行 DMA 的驱动程序使用三个不同的地址空间，如下图中所示。

![物理、 逻辑和虚拟地址映射](images/3addrspc.png)

在任何 Windows 平台上，驱动程序有权访问处理器支持的完整虚拟地址空间。 一个 32 位处理器上的虚拟地址空间表示四个千兆字节为单位。 CPU 使用的页表转换到系统的物理地址空间中的地址的虚拟地址空间中的地址。 每个页表项 (PTE) 映射到的物理内存，从而导致在必要时在分页操作页的虚拟内存的一页。 MDL （内存描述符列表） 提供了驱动程序 DMA 操作相关联的缓冲区的类似映射。

设备在其可以访问系统的整个虚拟地址空间会有所不同。 设备使用逻辑 （设备） 地址空间中的地址。 使用每个 HAL*映射寄存器*转换设备或逻辑地址与物理地址 （物理 RAM 中的位置）。 有关设备的硬件，映射寄存器执行相同函数的 MDL （和页表） 执行的软件 （驱动程序）： 它们将转换到的物理内存的地址。

由于这些地址空间进行单独寻址，驱动程序不能使用一个指针，虚拟地址空间中来解决物理内存中的位置，反之亦然。 该驱动程序必须首先将物理地址的虚拟地址。 同样，设备不能使用逻辑地址来直接访问物理内存。 设备必须首先将该地址。

HAL 必须设置为各种 DMA 的设备和不同的计算机上的 I/O 总线支持 DMA 的适配器对象。 例如，对于大多数 ISA DMA 控制器、 从属设备和总线 master 设备有不足地址行，以访问完整的 4 千兆字节系统物理地址空间的 32 位处理器 （或 x86 的 64 千兆字节系统物理地址处理器在 36 位 PAE 模式下运行的）。 与此相反，PCI DMA 设备通常具有多个足够地址行，以访问 32 位处理器中的完整系统的物理地址空间。 因此，每个 HAL 提供之间的映射*逻辑地址*DMA 的设备可以访问的范围和*物理地址*范围的每台计算机。

适配器的每个对象都与一个或多个映射寄存器，具体取决于要传输的数据量和可用内存量相关联。 在 DMA 传输过程 HAL 在 CPU 中使用别名设备可访问的逻辑页的物理内存页到每个映射寄存器。 实际上，映射寄存器的驱动程序，而不考虑他们的设备是否具有散播-聚集功能使用 DMA，提供散播-聚集支持。

### <a href="" id="address-mapping-for-a-sample-isa-dma-device"></a>

下图说明了不具有散播-聚集功能 ISA DMA 设备的驱动程序这样的物理到逻辑地址映射。

![示例 isa dma 设备的地址映射](images/3dmapreg.png)

上图显示了以下类型的映射：

1.  每个映射注册将一系列 （由实线指向） 的物理地址映射到低序位逻辑地址 （虚线） 为 ISA DMA 设备。

    在这里，三个映射寄存器用于别名三个分页范围到三个页面大小范围的低序位逻辑地址系统物理内存中的数据为 ISA DMA 设备。

2.  ISA 设备使用的映射的逻辑地址来在 DMA 操作期间访问系统内存。

    对于类似 PCI DMA 设备，三个映射寄存器也将用于对数据的三个页面大小的范围。 但是，映射的逻辑地址范围将不一定是相同的到相应的物理地址范围，因此 PCI 设备也可使用逻辑地址来访问系统内存。

3.  MDL 中的每个条目映射到物理地址的虚拟地址空间中的位置。

请注意映射寄存器和 MDL 中的虚拟物理项之间的对应关系：

-   每个映射寄存器和 MDL 中的每个虚拟条目最多映射 DMA 传输操作中的数据的完整物理页。

-   每个映射注册和 MDL 中的每个虚拟条目可能会小于一整页数据的映射。 例如，MDL 中的初始虚拟项可以将映射到某一偏移量从物理页边界，如前面所示在**物理、 逻辑和虚拟地址映射**图。

-   每个映射寄存器和 MDL 中的每个虚拟数据项映射，在最小值、 1 个字节。

在 IRP 请求读取或写入操作，在不透明的驱动程序 MDL 中每个虚拟数据项**Irp-&gt;MdlAddress**表示用户缓冲区的系统物理内存中的某个页边界。 同样，单个 DMA 传输所需的每个其他映射注册到系统的物理内存表示页边界中可访问设备的逻辑地址范围使用别名。

在每个 Windows 平台上，每个适配器对象具有一组关联的一个或多个映射寄存器位于特定于平台的 （和不透明的驱动程序） 的基址。 从驱动程序的角度来看，地图注册显示在图演示的基[地址映射的示例 ISA DMA 设备](#address-mapping-for-a-sample-isa-dma-device)是一组可能是硬件寄存器中的芯片，系统 DMA 控制器中的地图寄存器的句柄或在主机总线适配器中，或甚至可能是在系统内存中的 HAL 创建虚拟寄存器。

针对不同设备和 Windows 平台而异的与适配器对象一起提供的映射寄存器的数量。 例如，HAL 可以使多个映射到在比在其他平台上某些平台使用系统 DMA，因为在不同 Windows 平台上的 DMA 控制器具有不同的功能的驱动程序的可用寄存器。

 

 




