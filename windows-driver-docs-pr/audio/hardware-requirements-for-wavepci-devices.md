---
title: WavePci 设备的硬件要求
description: WavePci 设备的硬件要求
ms.assetid: 58a73ac1-baba-42df-a590-e7282f902157
keywords:
- WavePci 硬件要求 WDK 音频
- 总线主 WDK 音频
- 任意对齐 WDK 音频
- 内存 WDK 音频
- 缓存 WDK 音频
- 数据复制 WDK 音频
- 将音频数据复制
- 缓冲区 WDK 音频
- 拆分缓冲区帧 WDK 音频
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: a5d2aff4e6dddf2424cced3b47486422a289db6c
ms.sourcegitcommit: 0cc5051945559a242d941a6f2799d161d8eba2a7
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "63333626"
---
# <a name="hardware-requirements-for-wavepci-devices"></a>WavePci 设备的硬件要求


## <span id="hardware_requirements_for_wavepci_devices"></span><span id="HARDWARE_REQUIREMENTS_FOR_WAVEPCI_DEVICES"></span>


在选择新的硬件设计的功能时，供应商应遵循这些一般原则：

-   而不是尝试只需将所有处理都移动到硬件，供应商应该对性能权衡其影响针对每个功能的成本。

-   在考虑硬件功能的潜在价值，供应商应该评估以其对整个系统的影响，而不是有所侧重于特定的子系统，例如音频形式的该功能。

-   通过明智地选择要在硬件加速的功能，供应商可以减轻 CPU 工作负荷并改善内存使用情况，从而使更多的系统的资源可用于其他任务。

从历史上看，并非所有的音频硬件设计都已成功在遵循这些原则。

播放音频时内容或混合使用多个流、 某些 WDM 音频驱动程序不必要地占用大量 CPU 时间和总线带宽。 此类缺陷通常是有缺陷的硬件设计和效率低下的驱动程序实现的结果。 硬件设计缺陷还可以防止处理某些波形格式音频驱动程序或需要需要软件干预的解决方法。

WaveCyclic 设备模型的目的是以适应较旧的音频设备的硬件限制。 新的硬件设计应完全符合 WavePci。

可以执行，则返回 true 散播-聚集 DMA WavePci 设备无需 cpu 花费时间复制在缓冲区之间的音频数据。 与 WaveCyclic，不同 WavePci 有没有固有需数据复制，使其 multistream 或硬件加速的音频设备的首选微型端口驱动程序。 设计良好的 WavePci 设备应使用几乎没有 CPU 资源，从而可以将大量的音频流 （64 或更多） 发送到硬件 3-D 处理和混合使用。

WavePci 设备都需要支持散播-聚集 DMA 传输的总线 master DMA 控制器。 硬件设计应将任意限制放置 DMA 控制器可以处理的数据传输的类型。 WavePci 设备应满足以下要求：

-   **设备必须是总线 master。**

    它应该能够自主访问系统内存，而无需从操作系统干预，无需使用 DMA 的系统资源。

-   **设备必须能够处理任意长度的数据传输。**

    它应处理映射 (请参阅[ **IPortWavePciStream::GetMapping**](https://msdn.microsoft.com/library/windows/hardware/ff536909)) 大于内存页。 例如，4 千字节的传输有限的设备不符合 WavePci 的完整要求。 上支持 Microsoft Windows 的 64 位 Cpu，页大小为 8 千字节为单位，从而有可能某些映射将大于 4 千字节为单位的大小。 超过 32 千字节为单位的单个映射中的数据传输都是理论上，具体取决于物理内存碎片。 另一种极端，是可能的映射大小为 1 个字节。

-   **设备应处理数据传输到或从系统内存中的任何位置。**

    跨 32 千字节或更大电源的两个边界的数据传输都是很可能的。 计算机现在可以包含多个 4 千兆字节的 RAM，并在这些系统中，映射可找到更高版本比 4 千兆字节在 64 位 CPU 或物理 x86 的情况下的物理内存中地址扩展 (PAE)。 若要实现在这些计算机上的最佳性能，供应商应创建支持 64 位寻址的设备。 否则，在软件中复制的数据是必需的。 一直使用 24 位寻址具有超过 16 兆字节为单位的 RAM 的系统上对设备所需的数据复制。 设备应使用而不是 WavePci WaveCyclic，如果它们不能读取或写入到任意位置在物理内存中。 驱动程序可以做出这一决定在设备启动时 (请参阅[ **IRP\_MN\_启动\_设备**](https://msdn.microsoft.com/library/windows/hardware/ff551749)) 后才有机会以确定是否达到其地址是只需访问的完整地址范围的系统内存总线。

-   **设备应处理数据传输使用任意的对齐方式。**

    映射可以开始和结束任意字节边界上在内存中。 可以映射，其中的第一个映射的末尾的第几个通道示例和第二个映射中的其余通道中的示例之间拆分的音频数据帧。 有关示例，请参阅[批筛选器](wave-filters.md)。 有关一些示例的大小，可以映射之间拆分甚至示例容器。 如果设备需要传输必须位于缓存行边界，或如果设备需要传输严格符合音频帧边界 （例如，假设的传输大小均匀划分，立体声 16 位用例中为 4 个），此设备不能满足完成 WavePci 符合性。 请注意，可以通过限制数据范围或驱动程序 （例如，仅某些位深度或仅某些通道配置） 公开的格式公开为 WavePci 设备不符合要求的硬件。

有关上述列表中的最后一个点，WavePci 设备的分散/聚拢 DMA 引擎应处理跨内存页边界的缓冲区。 例如，包含 10 毫秒值得的 16 位 PCM 音频样本 48 kHz、 5.1 通道批流缓冲区具有以下大小：

(6 samples/frame)\*(2 bytes/sample)\*(48K frames/second)\*(10 milliseconds) = 5760 bytes

此值超出了内存页大小 （4096 个字节），这意味着，在缓冲区中包含一个或两个页边界，具体取决于如何放置在内存中。 在缓冲区中包含的音频数据帧的一个整数 (480)，但一个或两个这些帧可能跨页边界。

出于此原因，应设计 WavePci 设备的分散/聚拢 DMA 硬件来处理在内存中的两个物理上不连续页面之间拆分的音频框架 （如在下图中的帧 197）。

![说明页的起始偏移量位置处的音频缓冲区的关系图](images/framealign.png)

在上图中的顶部是跨越两个页之间的边界的 5760 字节缓冲区。 在此示例中，缓冲区将对齐到 64 字节边界在内存中缓冲区的开头的第一页开始 1728年字节偏移量位置处开始。 假定每个音频帧占据 12 个字节，并包含六个声道。 第一页包含所有帧 0 通过 196 但只有框架 197 的前四个字节。

图底部是音频帧 197，其中显示了仅为 0 和 1 的通道的示例在内的第一页的详细的视图。 第二个页中包含 2 到 5 的通道中的示例。

尽管两个页面顶部显示彼此，但它们是图的，实际上，仅在内核虚拟内存中连续。 由于包含缓冲区的网页中的物理内存不连续，散播-聚集 DMA 控制器，它使用物理地址，必须为其传输队列中的两个不同的项指定缓冲区的两个部分。 WavePci 端口驱动程序会自动将缓冲区拆分为两个单独的物理映射页边界处。

即使前面的示例更改用于对齐的第一页开始的缓冲区，拆分框架问题没有消失。 下图演示了这一点。 在这种情况下，在 0 和 1 的通道的示例页边界拆分框架 341 获取再次属于第一页和频道示例 2 到 5 中的第二页。

![说明对齐到页的开头的音频缓冲区的关系图](images/framealign2.png)

尽管软件的解决方法可能有助于缓解一些硬件设计缺陷，其散播-聚集 DMA 控制器未正确处理拆分音频帧 WavePci 设备限制在它可以处理的音频数据格式的类型中。 有关详细信息，请参阅[WavePci 延迟](wavepci-latency.md)。

 

 




